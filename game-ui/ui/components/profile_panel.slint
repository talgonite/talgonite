import { GameState, ProfileData, EquipmentSlotData } from "../game_state.slint";
import { Theme } from "../theme.slint";
import { ScrollView, VerticalBox, HorizontalBox } from "std-widgets.slint";
import { Icon } from "icon.slint";
import { BasePanel } from "base_panel.slint";

import "../../fonts/JetBrainsMono[wght].ttf";

component EquipmentSlot inherits Rectangle {
    in property <EquipmentSlotData> slot-data;
    in property <int> slot-id: 0;
    in property <bool> is-self: false;
    out property <bool> has-hover: touch.has-hover && is-self;

    width: 44px;
    height: 44px;
    background: Theme.surface-muted.with-alpha(0.05);
    border-width: 1px;
    border-radius: Theme.radius-small;
    border-color: Theme.border-muted.with-alpha(0.2);

    if slot-data.has-item: Icon {
        icon: slot-data.icon;
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        cooldown-total: 100ms;
        cooldown-left: (1.0 - slot-data.durability-percent) * 100ms;
    }

    touch := TouchArea {
        mouse-cursor: (slot-data.has-item && is-self) ? pointer : default;
        double-clicked => {
            if slot-data.has-item && is-self {
                GameState.unequip(slot-id);
            }
        }
    }

    states [
        hovered when touch.has-hover && is-self: {
            border-color: Theme.accent;
            background: Theme.surface-muted.with-alpha(0.3);
        }
        not-empty when slot-data.has-item: {
            background: Theme.surface-muted;
            border-color: Theme.border-muted;
        }
    ]
}

// Folder-style tab
component FolderTab inherits Rectangle {
    in property <string> label;
    in property <bool> active: false;
    callback clicked();
    width: 100px;
    height: active ? 36px : 32px;
    y: active ? 0px : 4px;
    background: active ? Theme.panel-background : Theme.surface-muted;
    border-top-left-radius: Theme.radius-medium;
    border-top-right-radius: Theme.radius-medium;
    border-width: 1px;
    border-color: active ? Theme.border-panel : Theme.border-muted;

    // Top edge highlight for active tab
    if active: Rectangle {
        x: 1px;
        y: 1px;
        width: parent.width - 2px;
        height: 12px;
        border-top-left-radius: Theme.radius-medium - 1px;
        border-top-right-radius: Theme.radius-medium - 1px;
        background: @linear-gradient(180deg, Theme.border-panel-highlight 0%, transparent 100%);
    }
    Text {
        text: label;
        font-size: Theme.font-size-small;
        font-weight: active ? 700 : 400;
        color: active ? Theme.accent : Theme.foreground-muted;
        horizontal-alignment: center;
        vertical-alignment: center;
    }

    tab-touch := TouchArea {
        mouse-cursor: pointer;
        clicked => {
            root.clicked();
        }
    }

    states [
        hovered when tab-touch.has-hover && !active: {
            background: Theme.surface-secondary;
        }
    ]
}

export component ProfilePanel inherits Rectangle {
    property <ProfileData> data: GameState.profile;
    property <string> active-tab: "profile";
    in property <float> preview-zoom: 2.0;
    width: 560px;
    height: 480px;

    HorizontalLayout {
        y: -32px;
        height: 36px;
        spacing: 4px;
        padding-left: 12px;
        FolderTab {
            label: "Profile";
            active: active-tab == "profile";
            clicked => {
                active-tab = "profile";
            }
        }

        FolderTab {
            label: "Legend";
            active: active-tab == "legend";
            clicked => {
                active-tab = "legend";
            }
        }
    }

    BasePanel {
        title: data.name == "" ? "Profile" : data.name;
        show-close: true;
        close => {
            GameState.profile.visible = false;
        }

        if active-tab == "profile": HorizontalLayout {
            padding: 12px;
            spacing: 12px;

            VerticalLayout {
                spacing: 12px;
                width: 330px;

                HorizontalLayout {
                    spacing: 8px;
                    alignment: center;
                    
                    // Column 1: Far Left
                    VerticalLayout {
                        spacing: 4px;
                        alignment: center;
                        eq14 := EquipmentSlot {
                            slot-data: data.eq-necklace;
                            slot-id: 6;
                            is-self: data.is-self;
                        }

                        eq6 := EquipmentSlot {
                            slot-data: data.eq-earrings;
                            slot-id: 5;
                            is-self: data.is-self;
                        }

                        eq17 := EquipmentSlot {
                            slot-data: data.eq-accessory1;
                            slot-id: 14;
                            is-self: data.is-self;
                        }
                    }

                    // Column 2: Inner Left
                    VerticalLayout {
                        spacing: 4px;
                        alignment: center;
                        eq15 := EquipmentSlot {
                            slot-data: data.eq-overcoat;
                            slot-id: 15;
                            is-self: data.is-self;
                        }

                        eq7 := EquipmentSlot {
                            slot-data: data.eq-weapon;
                            slot-id: 1;
                            is-self: data.is-self;
                        }

                        eq8 := EquipmentSlot {
                            slot-data: data.eq-left-gauntlet;
                            slot-id: 9;
                            is-self: data.is-self;
                        }

                        eq9 := EquipmentSlot {
                            slot-data: data.eq-left-ring;
                            slot-id: 7;
                            is-self: data.is-self;
                        }
                    }

                    // Column 3: Center (Head/Body/Feet)
                    VerticalLayout {
                        spacing: 8px;
                        alignment: center;
                        
                        // Helmets on top
                        HorizontalLayout {
                            spacing: 4px;
                            alignment: center;
                            eq16 := EquipmentSlot {
                                slot-data: data.eq-over-helmet;
                                slot-id: 16;
                                is-self: data.is-self;
                            }

                            eq1 := EquipmentSlot {
                                slot-data: data.eq-helmet;
                                slot-id: 4;
                                is-self: data.is-self;
                            }
                        }

                        Rectangle {
                            width: 84px;
                            height: 110px;
                            clip: true;
                            background: #00000020;
                            border-radius: 4px;
                            Image {
                                width: data.preview.width * root.preview-zoom * 1px;
                                height: data.preview.height * root.preview-zoom * 1px;
                                x: (parent.width - self.width) / 2;
                                y: (parent.height - self.height) / 2;
                                source: data.preview;
                                image-rendering: pixelated;
                            }
                        }

                        Rectangle {
                            width: 60px;
                            height: 18px;
                            background: #00000030;
                            border-radius: 4px;
                            x: (parent.width - self.width) / 2;
                            Text {
                                text: data.is-afk ? "Away" : "Online";
                                font-size: 9px;
                                color: data.is-afk ? #6b7280 : #22c55e;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }

                        // Boots/Greaves on bottom
                        HorizontalLayout {
                            spacing: 4px;
                            alignment: center;
                            eq4 := EquipmentSlot {
                                slot-data: data.eq-greaves;
                                slot-id: 12;
                                is-self: data.is-self;
                            }

                            eq5 := EquipmentSlot {
                                slot-data: data.eq-boots;
                                slot-id: 13;
                                is-self: data.is-self;
                            }
                        }
                    }

                    // Column 4: Inner Right
                    VerticalLayout {
                        spacing: 4px;
                        alignment: center;
                        eq2 := EquipmentSlot {
                            slot-data: data.eq-over-armor;
                            slot-id: 18;
                            is-self: data.is-self;
                        }

                        eq10 := EquipmentSlot {
                            slot-data: data.eq-shield;
                            slot-id: 3;
                            is-self: data.is-self;
                        }

                        eq11 := EquipmentSlot {
                            slot-data: data.eq-right-gauntlet;
                            slot-id: 10;
                            is-self: data.is-self;
                        }

                        eq12 := EquipmentSlot {
                            slot-data: data.eq-right-ring;
                            slot-id: 8;
                            is-self: data.is-self;
                        }
                    }

                    // Column 5: Far Right
                    VerticalLayout {
                        spacing: 4px;
                        alignment: center;
                        eq3 := EquipmentSlot {
                            slot-data: data.eq-armor;
                            slot-id: 2;
                            is-self: data.is-self;
                        }

                        eq13 := EquipmentSlot {
                            slot-data: data.eq-belt;
                            slot-id: 11;
                            is-self: data.is-self;
                        }

                        eq18 := EquipmentSlot {
                            slot-data: data.eq-accessory2;
                            slot-id: 17;
                            is-self: data.is-self;
                        }
                    }
                }

                if data.is-self: Rectangle {
                    property <EquipmentSlotData> hovered-item: 
                        eq1.has-hover ? eq1.slot-data : eq2.has-hover ? eq2.slot-data : eq3.has-hover ? eq3.slot-data : eq4.has-hover ? eq4.slot-data : eq5.has-hover ? eq5.slot-data : eq6.has-hover ? eq6.slot-data : eq7.has-hover ? eq7.slot-data : eq8.has-hover ? eq8.slot-data : eq9.has-hover ? eq9.slot-data : eq10.has-hover ? eq10.slot-data : eq11.has-hover ? eq11.slot-data : eq12.has-hover ? eq12.slot-data : eq13.has-hover ? eq13.slot-data : eq14.has-hover ? eq14.slot-data : eq15.has-hover ? eq15.slot-data : eq16.has-hover ? eq16.slot-data : eq17.has-hover ? eq17.slot-data : eq18.has-hover ? eq18.slot-data : { has-item: false };

                    height: 60px;
                    background: self.hovered-item.has-item ? #00000040 : transparent;
                    border-radius: 4px;
                    border-width: self.hovered-item.has-item ? 1px : 0px;
                    border-color: Theme.border-muted.with-alpha(0.3);
                    if self.hovered-item.has-item: VerticalLayout {
                        padding: 8px;
                        spacing: 2px;
                        Text {
                            text: hovered-item.name;
                            font-size: 13px;
                            font-weight: 700;
                            color: Theme.accent;
                        }

                        Text {
                            text: "Durability: " + hovered-item.current-durability + " / " + hovered-item.max-durability;
                            font-size: 10px;
                            color: #94a3b8;
                        }
                    }
                }
            }

            Rectangle {
                width: 1px;
                background: #00000060;
            }

            VerticalLayout {
                spacing: 12px;

                HorizontalLayout {
                    spacing: 12px;
                    if data.portrait.width > 0: Rectangle {
                        width: 68px;
                        height: 88px;
                        background: #00000030;
                        border-radius: 6px;
                        border-width: 1px;
                        border-color: #00000050;
                        Image {
                            source: data.portrait;
                            width: parent.width - 4px;
                            height: parent.height - 4px;
                            x: 2px;
                            y: 2px;
                            image-rendering: pixelated;
                        }
                    }

                    VerticalLayout {
                        spacing: 2px;
                        alignment: start;
                        Text {
                            text: data.name;
                            font-size: 16px;
                            font-weight: 700;
                            color: #e0e0e0;
                        }

                        Text {
                            text: data.class;
                            font-size: 14px;
                            color: #60a5fa;
                        }

                        if data.guild != "" || data.title != "": VerticalLayout {
                            spacing: 1px;
                            if data.guild != "": Text {
                                text: "<" + data.guild + "> " + data.guild-rank;
                                font-size: 11px;
                                color: #a0a0a0;
                            }
                            if data.title != "": Text {
                                text: "\"" + data.title + "\"";
                                font-size: 11px;
                                color: #c084fc;
                            }
                        }
                    }
                }

                HorizontalLayout {
                    spacing: 8px;
                    Rectangle {
                        width: 20px;
                        height: 14px;
                        background: data.town-banner.width > 0 ? transparent : #4a5568;
                        border-radius: 2px;
                        if data.town-banner.width > 0: Image {
                            source: data.town-banner;
                            width: parent.width;
                            height: parent.height;
                            image-rendering: pixelated;
                        }
                    }

                    Text {
                        text: data.town;
                        font-size: 12px;
                        color: #9ca3af;
                        vertical-alignment: center;
                    }
                }

                if data.profile-text != "": Rectangle {
                    background: #00000030;
                    border-radius: 6px;
                    border-width: 1px;
                    border-color: #00000050;

                    VerticalLayout {
                        padding: 6px;
                        Text {
                            text: data.profile-text;
                            font-size: 13px;
                            font-family: "JetBrains Mono";
                            color: #b0b0b0;
                            wrap: word-wrap;
                        }
                    }
                }

                Rectangle { }

                if !GameState.profile.is-self: HorizontalLayout {
                    alignment: start;
                    Rectangle {
                        width: 150px;
                        height: 30px;
                        background: data.group-requests-enabled ? (group-touch.has-hover ? #3b82f6 : #2563eb) : #4b5563;
                        border-radius: 6px;
                        border-width: 1px;
                        border-color: data.group-requests-enabled ? #60a5fa : #6b7280;
                        Text {
                            text: data.group-requests-enabled ? "Request Group" : "Requests Disabled";
                            font-size: 12px;
                            font-weight: 600;
                            color: data.group-requests-enabled ? #ffffff : #9ca3af;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }

                        group-touch := TouchArea {
                            mouse-cursor: data.group-requests-enabled ? pointer : not-allowed;
                        }
                    }
                }
            }
        }

        if active-tab == "legend": Rectangle {
            width: 100%;
            height: 100%;
            ScrollView {
                y: 35px;
                width: 100%;
                height: parent.height - 35px;
                viewport-width: self.visible-width;
                VerticalLayout {
                    padding: 10px;
                    spacing: 6px;
                    alignment: start;
                    for mark in data.legend-marks: Rectangle {
                        width: 100%;
                        height: 28px;
                        background: #00000020;
                        border-radius: 4px;
                        border-width: 1px;
                        border-color: #ffffff05;
                        HorizontalLayout {
                            padding-left: 8px;
                            padding-right: 8px;
                            spacing: 10px;
                            alignment: start;

                            Rectangle {
                                width: 20px;
                                height: 20px;
                                y: (parent.height - self.height) / 2;
                                background: mark.color.with-alpha(0.1);
                                border-radius: 3px;
                                border-width: 1px;
                                border-color: mark.color.with-alpha(0.3);
                                Text {
                                    text: mark.icon-name == "Yay" ? "★" : mark.icon-name == "Heart" ? "♥" : mark.icon-name == "Victory" ? "V" : mark.icon-name == "Warrior" ? "W" : mark.icon-name == "Rogue" ? "R" : mark.icon-name == "Wizard" ? "Z" : mark.icon-name == "Priest" ? "P" : mark.icon-name == "Monk" ? "M" : "•";
                                    color: mark.color;
                                    font-size: 12px;
                                    font-weight: 700;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }
                            }

                            Text {
                                text: mark.text;
                                color: #d1d5db;
                                font-size: 11px;
                                vertical-alignment: center;
                                overflow: elide;
                            }
                        }
                    }
                    if data.legend-marks.length == 0: Text {
                        text: "No legend marks recorded.";
                        font-size: 12px;
                        color: #6b7280;
                        horizontal-alignment: center;
                    }
                }
            }
        }
    }
}
