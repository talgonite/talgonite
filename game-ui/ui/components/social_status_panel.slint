import { Theme } from "../theme.slint";
import { ScrollView } from "std-widgets.slint";
import { SocialStatusState, SocialStatusEntry, SocialStatus } from "../game_state.slint";

// Status options - UI concern, lives in component
// Entries are indexed by SocialStatus enum order: Online=0, DoNotDisturb=1, etc.
global SocialStatusOptions {
    out property <[SocialStatusEntry]> entries: [
        { status: SocialStatus.Online,       name: "Online",         description: "Available for interaction",    icon: "●", color: #22c55e },
        { status: SocialStatus.DoNotDisturb, name: "Do Not Disturb", description: "Busy - please don't message",  icon: "⊘", color: #ef4444 },
        { status: SocialStatus.DayDreaming,  name: "Day Dreaming",   description: "Away from keyboard",           icon: "☽", color: #eab308 },
        { status: SocialStatus.NeedGroup,    name: "Need Group",     description: "Looking for a group",          icon: "⚑", color: #3b82f6 },
        { status: SocialStatus.Grouped,      name: "Grouped",        description: "Already in a group",           icon: "⚐", color: #8b5cf6 },
        { status: SocialStatus.LoneHunter,   name: "Lone Hunter",    description: "Hunting solo",                 icon: "◆", color: #6366f1 },
        { status: SocialStatus.GroupHunting, name: "Group Hunting",  description: "Hunting with group",           icon: "◇", color: #ec4899 },
        { status: SocialStatus.NeedHelp,     name: "Need Help",      description: "Requesting assistance",        icon: "?", color: #f97316 },
    ];
    
    // Get entry by status - uses enum index directly since entries are ordered to match enum
    public pure function get-entry(status: SocialStatus) -> SocialStatusEntry {
        if status == SocialStatus.Online { return entries[0]; }
        if status == SocialStatus.DoNotDisturb { return entries[1]; }
        if status == SocialStatus.DayDreaming { return entries[2]; }
        if status == SocialStatus.NeedGroup { return entries[3]; }
        if status == SocialStatus.Grouped { return entries[4]; }
        if status == SocialStatus.LoneHunter { return entries[5]; }
        if status == SocialStatus.GroupHunting { return entries[6]; }
        if status == SocialStatus.NeedHelp { return entries[7]; }
        return entries[0];
    }
    
    public pure function is-away(status: SocialStatus) -> bool {
        return status == SocialStatus.DayDreaming;
    }
    
    public pure function is-busy(status: SocialStatus) -> bool {
        return status == SocialStatus.DoNotDisturb;
    }
    
    public pure function is-lfg(status: SocialStatus) -> bool {
        return status == SocialStatus.NeedGroup;
    }
}

component StatusDot inherits Rectangle {
    in property <color> status-color: #22c55e;
    in property <bool> pulsing: false;
    
    width: 10px;
    height: 10px;
    border-radius: 5px;
    background: @radial-gradient(circle, status-color 0%, status-color.darker(0.3) 100%);
    border-width: 1px;
    border-color: status-color.darker(0.2);
}

component StatusOptionRow inherits Rectangle {
    in property <SocialStatusEntry> entry;
    in property <bool> is-selected: false;
    callback clicked();
    
    height: 36px;
    background: is-selected ? Theme.accent-subtle : touch.has-hover ? Theme.surface-secondary : transparent;
    border-radius: Theme.radius-small;
    
    animate background { duration: 100ms; }
    
    HorizontalLayout {
        padding-left: Theme.spacing-small;
        padding-right: Theme.spacing-small;
        spacing: Theme.spacing-small;
        
        StatusDot {
            status-color: entry.color;
            y: (parent.height - self.height) / 2;
        }
        
        VerticalLayout {
            spacing: 1px;
            alignment: center;
            
            Text {
                text: entry.name;
                color: is-selected ? Theme.accent : Theme.foreground;
                font-size: Theme.font-size-small;
                font-weight: is-selected ? 700 : 400;
            }
            
            Text {
                text: entry.description;
                color: Theme.foreground-subtle;
                font-size: Theme.font-size-xsmall;
            }
        }
        
        Rectangle { }
        
        if is-selected: Text {
            text: "✓";
            color: Theme.accent;
            font-size: Theme.font-size-medium;
            vertical-alignment: center;
        }
    }
    
    touch := TouchArea {
        clicked => { root.clicked(); }
    }
}

export component SocialStatusIndicator inherits Rectangle {
    in property <bool> interactive: true;
    in property <SocialStatus> status: SocialStatusState.current-status;
    in-out property <bool> dropdown-open: false;
    
    callback status-selected(SocialStatus);
    
    private property <SocialStatusEntry> current: SocialStatusOptions.get-entry(status);
    
    width: 120px;
    height: 28px;
    background: interactive && touch.has-hover ? Theme.surface-secondary : Theme.surface-muted;
    border-radius: Theme.radius-small;
    border-width: 1px;
    border-color: dropdown-open && interactive ? Theme.accent : Theme.border-muted;
    
    animate border-color { duration: 100ms; }
    
    HorizontalLayout {
        padding-left: Theme.spacing-small;
        padding-right: Theme.spacing-xsmall;
        spacing: Theme.spacing-small;
        
        Rectangle {
            width: 14px;
            
            StatusDot {
                status-color: current.color;
                pulsing: current.status == SocialStatus.NeedGroup || current.status == SocialStatus.NeedHelp;
                x: (parent.width - self.width) / 2;
                y: (parent.height - self.height) / 2;
            }
        }
        
        Text {
            text: current.name;
            color: Theme.foreground;
            font-size: Theme.font-size-small;
            vertical-alignment: center;
            overflow: elide;
        }
        
        Rectangle { }
        
        if interactive: Text {
            text: dropdown-open ? "▲" : "▼";
            color: Theme.foreground-muted;
            font-size: 8px;
            vertical-alignment: center;
        }
    }
    
    touch := TouchArea {
        enabled: interactive;
        clicked => {
            dropdown-open = !dropdown-open;
        }
    }
}

export component SocialStatusDropdown inherits Rectangle {
    in property <bool> show-above: false;
    in property <length> anchor-x: 0px;
    in property <length> anchor-y: 0px;
    in property <length> anchor-width: 120px;
    in property <length> anchor-height: 28px;
    in-out property <bool> open: false;
    in property <SocialStatus> current-status: SocialStatusState.current-status;
    
    callback status-selected(SocialStatus);
    
    visible: open && SocialStatusState.enabled;
    x: anchor-x;
    y: show-above ? (anchor-y - self.height - 4px) : (anchor-y + anchor-height + 4px);
    width: max(anchor-width, 200px);
    height: min(240px, SocialStatusOptions.entries.length * 38px + 8px);
    background: Theme.panel-background;
    border-radius: Theme.radius-medium;
    border-width: 1px;
    border-color: Theme.border-panel;
    drop-shadow-blur: 8px;
    drop-shadow-color: #00000040;
    drop-shadow-offset-y: 4px;
    
    VerticalLayout {
        padding: 4px;
        
        ScrollView {
            viewport-height: SocialStatusOptions.entries.length * 38px;
            VerticalLayout {
                spacing: 0px;
                for entry in SocialStatusOptions.entries: StatusOptionRow {
                    entry: entry;
                    is-selected: entry.status == current-status;
                    clicked => {
                        SocialStatusState.current-status = entry.status;
                        SocialStatusState.status-changed(entry.status);
                        root.status-selected(entry.status);
                        root.open = false;
                    }
                }
            }
        }
    }
}

export component SocialStatusDropdownOverlay inherits Rectangle {
    in-out property <bool> open: false;
    
    visible: open && SocialStatusState.enabled;
    background: transparent;
    
    TouchArea {
        clicked => {
            root.open = false;
        }
    }
}

export component SocialStatusPanel inherits Rectangle {
    in property <bool> show-dropdown-above: false;
    in property <bool> enabled: true;
    
    visible: enabled && SocialStatusState.enabled;
    width: indicator.width;
    height: indicator.height;
    background: transparent;
    
    indicator := SocialStatusIndicator {
        interactive: true;
    }
}

// Re-export for use by other components
export { SocialStatusOptions }
