import { GameState } from "../game_state.slint";
import { SettingsState } from "../settings_state.slint";
import { Theme } from "../theme.slint";

export component PlayerHUD inherits Rectangle {
    width: 280px;
    height: 80px;
    HorizontalLayout {
        spacing: 12px;

        // Character portrait
        Rectangle {
            width: 64px;
            height: 64px;
            y: (parent.height - self.height) / 2;

            // Portrait circle with border
            Rectangle {
                width: 64px;
                height: 64px;
                border-radius: 32px;
                background: @radial-gradient(circle, #2a2a3a 0%, #1a1a2a 100%);
                border-width: 2px;
                border-color: @linear-gradient(135deg, #4a4a5a 0%, #2a2a3a 100%);

                // Portrait image placeholder
                Rectangle {
                    x: 3px;
                    y: 3px;
                    width: parent.width - 6px;
                    height: parent.height - 6px;
                    border-radius: parent.border-radius - 3px;
                    background: @radial-gradient(circle, #3a3a4a 0%, #2a2a3a 100%);

                    // Actual player portrait
                    Image {
                        source: GameState.player_portrait;
                        width: 100%;
                        height: 100%;
                    }
                }

                // Subtle inner highlight
                Rectangle {
                    x: 3px;
                    y: 3px;
                    width: parent.width - 6px;
                    height: (parent.height - 6px) * 0.4;
                    border-radius: parent.border-radius - 3px;
                    background: @linear-gradient(180deg, #ffffff08 0%, transparent 100%);
                }
            }
        }

        // Info panel
        VerticalLayout {
            spacing: 4px;

            // Name and settings row
            HorizontalLayout {
                height: 24px;
                spacing: 8px;
                Text {
                    text: GameState.player_name;
                    color: Theme.foreground;
                    font-size: 14px;
                    font-weight: 700;
                    vertical-alignment: center;
                }

                // Settings Button
                Rectangle {
                    width: 20px;
                    height: 20px;
                    y: (parent.height - self.height) / 2;
                    background: SettingsState.show-settings ? Theme.accent-subtle : Theme.surface-muted;
                    border-radius: 4px;
                    border-width: 1px;
                    border-color: SettingsState.show-settings ? Theme.accent : Theme.border-muted;
                    Image {
                        source: @image-url("../icons/settings.svg");
                        width: 12px;
                        height: 12px;
                        x: (parent.width - self.width) / 2;
                        y: (parent.height - self.height) / 2;
                        colorize: SettingsState.show-settings ? Theme.accent : Theme.foreground-muted;
                    }

                    states [
                        hover when settings-touch.has-hover && !SettingsState.show-settings: {
                            background: Theme.surface-secondary;
                            border-color: Theme.accent;
                        }
                    ]
                    settings-touch := TouchArea {
                        clicked => {
                            SettingsState.show-settings = !SettingsState.show-settings;
                            SettingsState.show-game-menu = false;
                        }
                    }
                }

                // Game Menu Button (Logout/Exit)
                Rectangle {
                    width: 20px;
                    height: 20px;
                    y: (parent.height - self.height) / 2;
                    background: SettingsState.show-game-menu ? #ff444444 : Theme.surface-muted;
                    border-radius: 4px;
                    border-width: 1px;
                    border-color: SettingsState.show-game-menu ? #ff4444 : Theme.border-muted;
                    
                    // Simple "Power" icon manually drawn
                    Rectangle {
                        width: 10px;
                        height: 10px;
                        border-radius: 5px;
                        border-width: 1.5px;
                        border-color: SettingsState.show-game-menu ? #ffffff : Theme.foreground-muted;
                        x: (parent.width - self.width) / 2;
                        y: (parent.height - self.height) / 2;
                        
                        // Break in the top of the circle
                        Rectangle {
                            width: 4px;
                            height: 3px;
                            background: SettingsState.show-game-menu ? #552222 : #1a1a2a; // Match approximate background
                            x: (parent.width - self.width) / 2;
                            y: -1px;
                        }
                    }
                    Rectangle {
                        width: 1.5px;
                        height: 5px;
                        background: SettingsState.show-game-menu ? #ffffff : Theme.foreground-muted;
                        x: (parent.width - self.width) / 2;
                        y: (parent.height - self.height) / 2 - 2px;
                    }

                    states [
                        hover when menu-touch.has-hover && !SettingsState.show-game-menu: {
                            background: #442222;
                            border-color: #ff4444;
                        }
                    ]
                    menu-touch := TouchArea {
                        clicked => {
                            SettingsState.show-game-menu = !SettingsState.show-game-menu;
                            SettingsState.show-settings = false;
                        }
                    }
                }
            }

            // HP Bar
            HorizontalLayout {
                height: 18px;
                spacing: 6px;
                Rectangle {
                    width: 140px;
                    background: #00000040;
                    border-radius: 3px;
                    border-width: 1px;
                    border-color: #00000060;

                    // Fill
                    Rectangle {
                        x: 1px;
                        y: 1px;
                        width: max(0px, (parent.width - 2px) * max(0.0, min(1.0, GameState.current_hp / max(1, GameState.max_hp))));
                        height: parent.height - 2px;
                        background: @linear-gradient(90deg, #b91c1c 0%, #dc2626 50%, #ef4444 100%);
                        border-radius: 2px;
                    }

                    // Subtle overlay
                    Rectangle {
                        x: 1px;
                        y: 1px;
                        width: parent.width - 2px;
                        height: (parent.height - 2px) * 0.5;
                        background: @linear-gradient(180deg, #ffffff20 0%, transparent 100%);
                        border-radius: 2px;
                    }
                }

                Text {
                    text: GameState.current_hp;
                    color: #ff6b6b;
                    font-size: 11px;
                    font-weight: 700;
                    vertical-alignment: center;
                    min-width: 40px;
                    horizontal-alignment: right;
                }
            }

            // MP Bar
            HorizontalLayout {
                height: 18px;
                spacing: 6px;
                Rectangle {
                    width: 140px;
                    background: #00000040;
                    border-radius: 3px;
                    border-width: 1px;
                    border-color: #00000060;

                    // Fill
                    Rectangle {
                        x: 1px;
                        y: 1px;
                        width: max(0px, (parent.width - 2px) * max(0.0, min(1.0, GameState.current_mp / max(1, GameState.max_mp))));
                        height: parent.height - 2px;
                        background: @linear-gradient(90deg, #1e40af 0%, #2563eb 50%, #3b82f6 100%);
                        border-radius: 2px;
                    }

                    // Subtle overlay
                    Rectangle {
                        x: 1px;
                        y: 1px;
                        width: parent.width - 2px;
                        height: (parent.height - 2px) * 0.5;
                        background: @linear-gradient(180deg, #ffffff20 0%, transparent 100%);
                        border-radius: 2px;
                    }
                }

                Text {
                    text: GameState.current_mp;
                    color: #60a5fa;
                    font-size: 11px;
                    font-weight: 700;
                    vertical-alignment: center;
                    min-width: 40px;
                    horizontal-alignment: right;
                }
            }

            // Subtle info row
            HorizontalLayout {
                height: 14px;
                spacing: 8px;
                Text {
                    text: GameState.map_name;
                    color: #8a8a8a;
                    font-size: 9px;
                    vertical-alignment: center;
                }

                Rectangle {
                    width: 6px;
                    height: 6px;
                    border-radius: 3px;
                    y: (parent.height - self.height) / 2;
                    background: {
                        if GameState.ping_ms < 100 {
                            @radial-gradient(circle, #22c55e 0%, #16a34a 100%)
                        } else if GameState.ping_ms < 200 {
                            @radial-gradient(circle, #eab308 0%, #ca8a04 100%)
                        } else {
                            @radial-gradient(circle, #ef4444 0%, #dc2626 100%)
                        }
                    };
                }
            }
        }
    }
}
