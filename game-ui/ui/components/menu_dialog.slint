import { GameState, MenuEntry } from "../game_state.slint";
import { ScrollView, LineEdit } from "std-widgets.slint";
import { Icon } from "icon.slint";

export component MenuDialog inherits Rectangle {
    visible: GameState.show_menu;
    background: #00000088;

    // Click outside to close
    TouchArea {
        clicked => {
            GameState.show_menu = false;
        }
    }

    // Dialog panel
    Rectangle {
        width: GameState.menu_is_shop ? 430px : 300px;
        height: min(root.height - 60px, dialog-content.preferred-height);
        background: #1a1a2ef0;
        border-radius: 8px;
        border-width: 1px;
        border-color: #00000080;

        // Inner highlight
        Rectangle {
            x: 1px;
            y: 1px;
            width: parent.width - 2px;
            height: parent.height - 2px;
            border-radius: 7px;
            border-width: 1px;
            border-color: #ffffff08;
        }

        // Close button
        Rectangle {
            x: parent.width - 32px;
            y: 8px;
            width: 24px;
            height: 24px;
            background: close-touch.has-hover ? #ff4444 : #00000040;
            border-radius: 4px;

            Text {
                text: "X";
                font-size: 14px;
                font-weight: 700;
                color: #e0e0e0;
                horizontal-alignment: center;
                vertical-alignment: center;
            }

            close-touch := TouchArea {
                clicked => {
                    GameState.show_menu = false;
                }
            }
        }

        dialog-content := VerticalLayout {
            padding: 16px;
            spacing: 10px;

            // Title
            Text {
                text: GameState.menu_title;
                font-size: 16px;
                font-weight: 600;
                color: #e0e0e0;
            }

            // Divider
            Rectangle {
                height: 1px;
                background: #00000060;
            }

            // NPC text
            if GameState.menu_text != "": Text {
                text: GameState.menu_text;
                font-size: 12px;
                color: #a0a0a0;
                wrap: word-wrap;
            }

            // Text options (no scroll)
            if !GameState.menu_is_shop: VerticalLayout {
                spacing: 4px;

                for entry in GameState.menu_entries: Rectangle {
                    height: 28px;
                    background: entry-touch.has-hover ? #ffffff10 : #00000020;
                    border-radius: 4px;
                    border-width: 1px;
                    border-color: entry-touch.has-hover ? #FFC04080 : #ffffff05;

                    entry-touch := TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            GameState.show_menu = false;
                            GameState.menu_select(entry.id, entry.text);
                        }
                    }

                    Text {
                        text: entry.text;
                        font-size: 12px;
                        color: #e0e0e0;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }

            // Shop items (2-column grid with scroll)
            if GameState.menu_is_shop: ScrollView {
                min-height: 400px;
                viewport-width: self.visible-width;

                GridLayout {
                    spacing: 6px;

                    for entry[idx] in GameState.menu_entries: Rectangle {
                        row: Math.floor(idx / 2);
                        col: Math.mod(idx, 2);
                        width: 190px;
                        height: 36px;
                        background: item-touch.has-hover ? #ffffff10 : #00000020;
                        border-radius: 4px;
                        border-width: 1px;
                        border-color: item-touch.has-hover ? #FFC04080 : #ffffff05;

                        item-touch := TouchArea {
                            mouse-cursor: pointer;
                            clicked => {
                                GameState.show_menu = false;
                                GameState.menu_select(entry.id, entry.text);
                            }
                        }

                        HorizontalLayout {
                            padding-left: 4px;
                            padding-right: 8px;
                            spacing: 8px;

                            Rectangle {
                                width: 28px;
                                height: 28px;
                                y: (parent.height - self.height) / 2;
                                background: #00000040;
                                border-radius: 3px;

                                Icon {
                                    icon: entry.icon;
                                    x: (parent.width - self.width) / 2;
                                    y: (parent.height - self.height) / 2;
                                }
                            }

                            VerticalLayout {
                                alignment: center;
                                spacing: 1px;

                                Text {
                                    text: entry.text;
                                    font-size: 11px;
                                    color: #e0e0e0;
                                    overflow: elide;
                                }

                                if entry.cost > 0: Text {
                                    text: entry.cost;
                                    font-size: 9px;
                                    color: #FFC040;
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}

export component TextEntryDialog inherits Rectangle {
    visible: GameState.show_text_entry;
    background: #00000088;

    property <string> input-text: "";

    // Click outside to close
    TouchArea {
        clicked => {
            GameState.show_text_entry = false;
        }
    }

    // Dialog panel
    Rectangle {
        width: 300px;
        height: dialog-content.preferred-height + 32px;
        background: #1a1a2ef0;
        border-radius: 8px;
        border-width: 1px;
        border-color: #00000080;

        // Inner highlight
        Rectangle {
            x: 1px;
            y: 1px;
            width: parent.width - 2px;
            height: parent.height - 2px;
            border-radius: 7px;
            border-width: 1px;
            border-color: #ffffff08;
        }

        // Close button
        Rectangle {
            x: parent.width - 32px;
            y: 8px;
            width: 24px;
            height: 24px;
            background: close-touch.has-hover ? #ff4444 : #00000040;
            border-radius: 4px;

            Text {
                text: "X";
                font-size: 14px;
                font-weight: 700;
                color: #e0e0e0;
                horizontal-alignment: center;
                vertical-alignment: center;
            }

            close-touch := TouchArea {
                clicked => {
                    GameState.show_text_entry = false;
                }
            }
        }

        dialog-content := VerticalLayout {
            padding: 16px;
            spacing: 12px;

            // Title
            Text {
                text: GameState.menu_title;
                font-size: 16px;
                font-weight: 600;
                color: #e0e0e0;
            }

            // Divider
            Rectangle {
                height: 1px;
                background: #00000060;
            }

            // NPC text / prompt
            if GameState.menu_text != "": Text {
                text: GameState.menu_text;
                font-size: 12px;
                color: #a0a0a0;
                wrap: word-wrap;
            }

            // Args (e.g. item name for count prompt)
            if GameState.text_entry_args != "": Text {
                text: GameState.text_entry_args;
                font-size: 14px;
                color: #FFC040;
                font-weight: 500;
                horizontal-alignment: center;
            }

            // Text input
            LineEdit {
                height: 32px;
                text <=> root.input-text;
                accepted => {
                    if root.input-text != "" {
                        GameState.show_text_entry = false;
                        GameState.menu_select(
                            0,
                            root.input-text);
                        root.input-text = "";
                    }
                }
            }

            // Buttons
            HorizontalLayout {
                spacing: 8px;

                Rectangle {
                    height: 28px;
                    background: cancel-touch.has-hover ? #ffffff10 : #00000020;
                    border-radius: 4px;
                    border-width: 1px;
                    border-color: #ffffff10;

                    cancel-touch := TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            GameState.show_text_entry = false;
                            root.input-text = "";
                        }
                    }

                    Text {
                        text: "Cancel";
                        font-size: 12px;
                        color: #a0a0a0;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }

                Rectangle {
                    height: 28px;
                    background: submit-touch.has-hover ? #FFC04040 : #FFC04020;
                    border-radius: 4px;
                    border-width: 1px;
                    border-color: #FFC04080;

                    submit-touch := TouchArea {
                        mouse-cursor: pointer;
                        clicked => {
                            if root.input-text != "" {
                                GameState.show_text_entry = false;
                                GameState.menu_select(
                                    0,
                                    root.input-text);
                                root.input-text = "";
                            }
                        }
                    }

                    Text {
                        text: "Submit";
                        font-size: 12px;
                        color: #FFC040;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }
        }
    }
}
