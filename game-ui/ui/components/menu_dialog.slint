import { NpcDialogState, MenuEntry } from "../game_state.slint";
import { ScrollView, LineEdit, VerticalBox } from "std-widgets.slint";
import { Theme } from "../theme.slint";
import { Icon } from "icon.slint";


import "../fonts/Lato-Regular.ttf";
import "../fonts/Lato-Light.ttf";
import "../fonts/Lato-Thin.ttf";
import "../fonts/Lato-Bold.ttf";
import "../fonts/Lato-Black.ttf";
import "../fonts/Lato-Italic.ttf";
import "../fonts/Lato-LightItalic.ttf";
import "../fonts/Lato-ThinItalic.ttf";
import "../fonts/Lato-BoldItalic.ttf";
import "../fonts/Lato-BlackItalic.ttf";

// ============================================================================
// MAIN NPC DIALOG
// ============================================================================
export component NpcDialog inherits Rectangle {
    property <image> npc-portrait: NpcDialogState.npc-portrait;
    TouchArea {
        clicked => {
            NpcDialogState.close();
        }
    }

    background: #0007;
    HorizontalLayout {
        alignment: center;
        VerticalLayout {
            alignment: end;
            preferred-width: 660px;
            HorizontalLayout {
                alignment: center;
                z: 10;
                VerticalLayout {
                    alignment: end;
                    preferred-width: 660px;
                    HorizontalLayout {
                        padding-left: 32px;
                        padding-right: self.padding-left;
                        spacing: 8px;

                    // Portrait
                    VerticalLayout {
                            alignment: end;
                            if (npc-portrait.width > 100): Image {
                                source: npc-portrait;
                                height: self.width / (self.source.width / self.source.height);
                                preferred-width: 320px;
                                image-fit: ImageFit.contain;
                            }
                            if (npc-portrait.width <= 100 && npc-portrait.width > 0): HorizontalLayout {
                                alignment: center;
                                Image {
                                    source: npc-portrait;
                                    width: self.source.width * 2px;
                                    height: self.source.height * 2px;
                                    image-fit: ImageFit.contain;
                                    image-rendering: pixelated;
                                }
                            }
                            HorizontalLayout {
                                height: 0px;
                                padding-top: -18px;
                                Rectangle {
                                    height: 36px;
                                    background: #28210F;
                                    Image {
                                        width: parent.width;
                                        height: parent.height;
                                        source: @image-url("../panel/Default/Panel/panel-007.png", nine-slice(18));
                                        colorize: #6c3f1c;
                                    }

                                    HorizontalLayout {
                                        alignment: center;
                                        padding-left: 32px;
                                        padding-right: self.padding-left;
                                        portrait-npc-name := Text {
                                            font-family: "Lato";
                                            font-size: 20px;
                                            text: NpcDialogState.npc-name;
                                            vertical-alignment: center;
                                            font-weight: 500;
                                        }
                                    }
                                }
                            }
                        }

                        Rectangle { }

                        // Menu options
                        VerticalLayout {
                            alignment: end;
                            if (!NpcDialogState.is-shop): VerticalLayout {
                                Rectangle {
                                    background: @linear-gradient(0deg, #0000 0%, #0007 15%, #0007 85%, #0000 100%);
                                    VerticalLayout {
                                        padding: 24px;
                                        for entry in NpcDialogState.menu-entries: Rectangle {
                                            animate background { duration: 100ms; }
                                            touch := TouchArea {
                                                mouse-cursor: pointer;
                                                clicked => {
                                                    NpcDialogState.select-option(entry.id, entry.text);
                                                }
                                            }

                                            HorizontalLayout {
                                                padding: 22px;
                                                padding-top: 6px;
                                                padding-bottom: self.padding-top;
                                                Text {
                                                    text: entry.text;
                                                    font-size: 14px;
                                                    font-family: "Lato";
                                                    color: Theme.foreground;
                                                    horizontal-alignment: left;
                                                    font-weight: 700;
                                                    font-italic: true;
                                                }
                                            }

                                            states [
                                                hover when touch.has-hover: {
                                                    background: #ffffff10;
                                                }
                                            ]
                                        }
                                    }
                                }
                            }
                            if (NpcDialogState.is-shop): VerticalLayout {
                                Rectangle {
                                    background: @linear-gradient(0deg, #0000 0%, #0007 15%, #0007 85%, #0000 100%);
                                    preferred-height: 240px;
                                    width: 260px;
                                    ScrollView {
                                        GridLayout {
                                            spacing: 10px;
                                            padding: 5px;
                                            for entry[idx] in NpcDialogState.menu-entries: Rectangle {
                                                row: Math.floor(idx / 2);
                                                item-touch := TouchArea {
                                                    mouse-cursor: pointer;
                                                    clicked => {
                                                        NpcDialogState.select-option(entry.id, entry.text);
                                                    }
                                                }

                                                HorizontalLayout {
                                                    padding-left: 4px;
                                                    padding-right: 8px;
                                                    spacing: 8px;
                                                    Rectangle {
                                                        width: 28px;
                                                        height: 28px;
                                                        y: (parent.height - self.height) / 2;
                                                        background: #00000040;
                                                        border-radius: 3px;
                                                        Icon {
                                                            icon: entry.icon;
                                                            x: (parent.width - self.width) / 2;
                                                            y: (parent.height - self.height) / 2;
                                                        }
                                                    }

                                                    VerticalLayout {
                                                        alignment: center;
                                                        spacing: 1px;
                                                        Text {
                                                            text: entry.text;
                                                            font-size: 11px;
                                                            color: #e0e0e0;
                                                            overflow: elide;
                                                        }

                                                        if entry.cost > 0: Text {
                                                            text: entry.cost;
                                                            font-size: 9px;
                                                            color: #ffc040;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }

            Rectangle {
                background: #f5dec2;
                preferred-height: 80px;
                Image {
                    width: parent.width;
                    height: parent.height;
                    source: @image-url("../panel/Default/Panel/panel-014.png", nine-slice(16));
                    colorize: #b08869;
                }

                VerticalLayout {
                    alignment: center;
                    padding: 24px;
                    padding-top: 32px;
                    Text {
                        font-family: "Lato";
                        font-size: 16px;
                        font-weight: 700;
                        text: NpcDialogState.dialog-text;
                        horizontal-alignment: left;
                        wrap: word-wrap;
                        color: #28210F;
                    }
                }
            }

            Rectangle {
                preferred-height: 120px;
            }
        }
    }
}

// ============================================================================
// TEXT ENTRY OVERLAY - Floats above the dialog, can cover portrait
// ============================================================================
export component TextEntryDialog inherits Rectangle {
    visible: NpcDialogState.text-entry-visible;
    property <string> input-text: "";

    // Darker overlay on top
    Rectangle {
        width: 100%;
        height: 100%;
        background: #000000aa;
        TouchArea {
            clicked => {
                NpcDialogState.text-entry-visible = false;
            }
        }
    }

    // Centered entry box
    VerticalLayout {
        alignment: center;
        HorizontalLayout {
            alignment: center;
            Rectangle {
                width: 380px;
                background: @linear-gradient(180deg, #222240 0%, #1a1a35 100%);
                border-radius: 14px;
                border-width: 2px;
                border-color: #ffffff18;
                drop-shadow-blur: 30px;
                drop-shadow-color: #000000cc;
                TouchArea { }

                VerticalLayout {
                    padding: 28px;
                    spacing: 20px;

                    // Header
                    HorizontalLayout {
                        Text {
                            text: NpcDialogState.npc-name;
                            font-size: 18px;
                            font-weight: 600;
                            color: Theme.foreground-strong;
                            horizontal-stretch: 1;
                        }

                        Rectangle {
                            width: 32px;
                            height: 32px;
                            border-radius: 8px;
                            background: entry-x-touch.has-hover ? #ff444428 : transparent;
                            entry-x-touch := TouchArea {
                                mouse-cursor: pointer;
                                clicked => {
                                    NpcDialogState.text-entry-visible = false;
                                }
                            }

                            Text {
                                text: "\u{00D7}";
                                font-size: 20px;
                                color: entry-x-touch.has-hover ? #ff6666 : Theme.foreground-muted;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                    }

                    // Prompt
                    if NpcDialogState.text-entry-prompt != "": Text {
                        text: NpcDialogState.text-entry-prompt;
                        font-size: 14px;
                        color: Theme.foreground-muted;
                        wrap: word-wrap;
                    }

                    // Args highlight (item name etc)
                    if NpcDialogState.text-entry-args != "": Rectangle {
                        height: 44px;
                        background: #FFC04010;
                        border-radius: 10px;
                        border-width: 1px;
                        border-color: #FFC04030;
                        Text {
                            text: NpcDialogState.text-entry-args;
                            font-size: 15px;
                            font-weight: 500;
                            color: Theme.accent;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    // Input
                    LineEdit {
                        height: 46px;
                        text <=> root.input-text;
                        accepted => {
                            if root.input-text != "" {
                                NpcDialogState.submit-text(root.input-text);
                                NpcDialogState.text-entry-visible = false;
                                root.input-text = "";
                            }
                        }
                    }

                    // Buttons
                    HorizontalLayout {
                        spacing: 14px;
                        Rectangle {
                            horizontal-stretch: 1;
                            height: 46px;
                            border-radius: 10px;
                            background: cancel-touch.pressed ? #ffffff18 : cancel-touch.has-hover ? #ffffff0c : #ffffff06;
                            border-width: 1px;
                            border-color: #ffffff15;
                            cancel-touch := TouchArea {
                                mouse-cursor: pointer;
                                clicked => {
                                    NpcDialogState.text-entry-visible = false;
                                    root.input-text = "";
                                }
                            }

                            Text {
                                text: "Cancel";
                                font-size: 14px;
                                color: Theme.foreground;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }

                        Rectangle {
                            horizontal-stretch: 1;
                            height: 46px;
                            border-radius: 10px;
                            background: root.input-text == "" ? #FFC04008 : submit-touch.pressed ? #FFC04050 : submit-touch.has-hover ? #FFC04030 : #FFC04018;
                            border-width: 1px;
                            border-color: #FFC04050;
                            opacity: root.input-text == "" ? 0.5 : 1.0;
                            submit-touch := TouchArea {
                                mouse-cursor: root.input-text != "" ? pointer : default;
                                clicked => {
                                    if root.input-text != "" {
                                        NpcDialogState.submit-text(root.input-text);
                                        NpcDialogState.text-entry-visible = false;
                                        root.input-text = "";
                                    }
                                }
                            }

                            Text {
                                text: "Submit";
                                font-size: 14px;
                                font-weight: 500;
                                color: Theme.accent;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                    }
                }
            }
        }
    }
}
